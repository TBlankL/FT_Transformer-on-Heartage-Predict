# 样本权重计算原理详解

## 概述

在年龄预测任务中，不同年龄段的样本数量往往不平衡。为了处理这种不平衡问题，我们使用**逆频率权重**（Inverse Frequency Weighting）来给少数样本更高的权重。

## 权重计算公式

### 基本公式
```
权重 = max_count / age_count
```

其中：
- `max_count`: 所有年龄段中样本数量最多的值
- `age_count`: 当前年龄段的样本数量

### 具体实现代码
```python
# 1. 统计每个年龄段的样本数量
age_counts_filtered = df.groupby('age').size()

# 2. 找到样本数量最多的年龄段
max_count = age_counts_filtered.max()

# 3. 为每个样本计算权重
sample_weights = df['age'].map(lambda x: max_count / age_counts_filtered[x])
```

## 权重计算原理

### 1. 问题背景

在年龄预测数据集中，通常存在以下问题：
- **多数年龄**：某些年龄段样本很多（如30-50岁）
- **少数年龄**：某些年龄段样本很少（如20岁以下、70岁以上）
- **不平衡影响**：模型容易偏向多数年龄，忽略少数年龄

### 2. 权重设计思想

**核心思想**：给少数样本更高的权重，给多数样本更低的权重

**数学原理**：
- 权重与样本数量成反比
- 样本越少，权重越高
- 样本越多，权重越低

### 3. 权重计算示例

假设有以下年龄分布：

| 年龄 | 样本数量 | 权重计算 | 权重值 |
|------|----------|----------|--------|
| 25   | 100      | 200/100  | 2.0    |
| 30   | 200      | 200/200  | 1.0    |
| 35   | 150      | 200/150  | 1.33   |
| 40   | 50       | 200/50   | 4.0    |
| 45   | 200      | 200/200  | 1.0    |

**解释**：
- 年龄30和45样本最多（200个），权重为1.0（基准权重）
- 年龄40样本最少（50个），权重最高（4.0）
- 年龄25样本较多（100个），权重较高（2.0）
- 年龄35样本中等（150个），权重适中（1.33）

## 权重的作用机制

### 1. 在损失函数中的应用

**标准R²损失**：
```
损失 = SS_res / SS_tot
```

**加权R²损失**：
```
加权SS_res = Σ(wi * (yi - ŷi)²)
加权SS_tot = Σ(wi * (yi - ȳ)²)
加权R² = 1 - (加权SS_res / 加权SS_tot)
```

其中 `wi` 是第i个样本的权重。

### 2. 权重对训练的影响

**高权重样本**：
- 在损失计算中贡献更大
- 模型更关注这些样本的预测准确性
- 有助于学习少数年龄的特征

**低权重样本**：
- 在损失计算中贡献较小
- 模型不会过度拟合这些样本
- 保持对多数年龄的平衡学习

## 权重计算的优势

### 1. 解决数据不平衡
- **问题**：少数年龄样本被忽略
- **解决**：通过权重提高少数样本的重要性

### 2. 提高模型泛化能力
- **问题**：模型偏向多数年龄
- **解决**：平衡不同年龄段的关注度

### 3. 改善R²指标
- **问题**：整体R²可能被多数年龄主导
- **解决**：加权R²更公平地评估所有年龄段

## 权重计算的局限性

### 1. 可能过度补偿
- 少数样本权重过高可能导致过拟合
- 需要监控验证集性能

### 2. 计算复杂度增加
- 需要额外的权重计算和存储
- 训练时间可能略有增加

### 3. 超参数敏感性
- 权重计算方式可能影响最终性能
- 需要根据具体数据集调整

## 实际应用建议

### 1. 权重范围控制
```python
# 限制权重范围，避免极端值
sample_weights = np.clip(sample_weights, 0.1, 10.0)
```

### 2. 权重平滑
```python
# 使用平方根平滑权重
sample_weights = np.sqrt(sample_weights)
```

### 3. 动态权重调整
```python
# 根据训练进度调整权重强度
weight_factor = 1.0 - (epoch / total_epochs) * 0.5
sample_weights = sample_weights ** weight_factor
```

## 监控和调试

### 1. 权重分布分析
```python
import matplotlib.pyplot as plt

plt.hist(sample_weights, bins=50)
plt.xlabel('Weight')
plt.ylabel('Frequency')
plt.title('Sample Weight Distribution')
plt.show()
```

### 2. 年龄-权重关系
```python
age_weight_df = df.groupby('age')['sample_weight'].agg(['mean', 'std', 'count'])
print(age_weight_df)
```

### 3. 训练过程监控
- 监控不同年龄段的预测误差
- 观察权重对损失函数的影响
- 比较加权前后的R²变化

## 总结

样本权重计算是一种有效的数据不平衡处理方法：

1. **计算简单**：基于样本数量的逆频率权重
2. **原理清晰**：给少数样本更高权重
3. **效果显著**：改善模型对少数年龄的预测能力
4. **易于实现**：代码简洁，易于理解和调试

通过合理使用样本权重，可以显著提升年龄预测模型在不平衡数据集上的性能，特别是对少数年龄段的预测准确性。
